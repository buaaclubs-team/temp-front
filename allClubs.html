<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>百团荟萃</title>
	<link rel="stylesheet" type="text/css" href="font/iconfont.css">
	<link rel="stylesheet" type="text/css" href="header2.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="js/juicer-min.js"></script>
	<script type="text/javascript" src = "js/md5.js"></script>
	<script type="text/javascript" src="js/json2.js"></script>
	<script type="text/javascript" src="main.js"></script>
</head>
<body>
	<div class = "app">
		<div class = "header">
			<div class="hd-content">
				<div class="logo">
					<img src="img/clubs-logo.png" alt="">
				</div>
				<ul class="nav">
					<li>
						<a href="index.html" class = "">
							<span class = "iconfont icon">&#xe60e;</span>
							<span>首页</span>
						</a>
					</li>
					<li>
						<a href="allClubs.html" class = "cur">
							<span class = "iconfont icon">&#xe631;</span>
							<span>百团</span>
						</a>
					</li>
					<li>
						<a href="discovery.html">
							<span class = "iconfont icon">&#xe600;</span>
							<span>发现</span>
						</a>
					</li>
				</ul>
				<ul class="nav hd-user" id="nav-user">
					<div>
						<li >
							<a href="javascript:void(0)" class = "callModel">
								<span class = "iconfont icon">&#xe610;</span>
								<span>请登录</span>
							</a>
						</li>
					</div>
					<div class = "hd-hide">
						<li>
							<a href="javascript:void(0)">
								<span class = "iconfont icon">&#xe610;</span>
								<span> </span>
							</a>
						</li>
						<li>
							<a href="javascript:void(0)">
								<span class = "iconfont icon">&#xe618;<i class = ""></i></span>
							</a>
						</li>
						<li>
							<a href="javascript:void(0)" id = "logout-btn">
								<span class = "iconfont icon" style = "font-size:22px;">&#xe608;</span>
							</a>
						</li>
					</div>
				</ul>
			</div>
		</div>

		<div class="main">
			<div class="left-nav">
				<div class="left-item">
					<h3>
						<a href="index.html" class = ""><span>首页</span></a>
					</h3>
				</div>
				<div class="left-item">
					<h3>
						<a href="javascript:void(0)" class = "cur"><span>百团荟萃</span></a>
					</h3>
				</div>
				<div class="left-item">
					<h3>
						<a href="discovery.html"><span>发现活动</span></a>
					</h3>
				</div>
				<div id = "leftLogin" style = "display: none;">
					<div class="left-line"></div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>我的社团</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>我的活动</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>个人信息</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>站内信</span></a>
						</h3>
					</div>
				</div>
			</div>
			<div class="right-main">
				<div class="right-card allclub hd" id="test2">
					<div id="tiyuClub">
						<div class = "allclub-split">
							<p>体育类</p>
							<div></div>
						</div>
						<!-- 由juicer填充 -->
					</div>
					<div id = "shijianClub">
						<div class = "allclub-split">
							<p>实践类</p>
							<div></div>
						</div>
						<!-- 由juicer填充 -->
					</div>
					<div id="kejiClub">
						<div class = "allclub-split">
							<p>科技类</p>
							<div></div>
						</div>
						<!-- 由juicer填充 -->
					</div>
				</div>
				
			</div>
		</div>
		<br>
	</div>
	
	<div class="cd-user-modal"> 
		<div class="cd-user-modal-container">
			<ul class="cd-switcher">
				<li><a href="#0">用户登录</a></li>
				<li><a href="#0">注册新用户</a></li>
			</ul>

			<div id="cd-login"> <!-- 登录表单 -->
				<form class="cd-form">
					<p class="fieldset">
						<label class="image-replace cd-username" for="signin-username">学号</label>
						<input class="full-width has-padding has-border" id="signin-id" type="text" placeholder="输入学号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-password" for="signin-password">密码</label>
						<input class="full-width has-padding has-border" id="signin-password" type="password"  placeholder="输入密码">
					</p>

					<p class="fieldset">
						<input class="full-width2 button1" id = "signin-btn" type="submit" value="登 录">
					</p>
				</form>
			</div>

			<div id="cd-signup"> <!-- 注册表单 -->
				<form class="cd-form">
					<p class="fieldset">
						<label class="image-replace cd-username" for="signup-username">学号</label>
						<input class="full-width has-padding has-border" id="signup-id" type="text" placeholder="输入学号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-email" for="signup-email">姓名</label>
						<input class="full-width has-padding has-border" id="signup-name" type="email" placeholder="输入姓名">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-email" for="signup-email">邮箱</label>
						<input class="full-width has-padding has-border" id="signup-email" type="email" placeholder="输入邮箱">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-email" for="signup-email">手机</label>
						<input class="full-width has-padding has-border" id="signup-tel" type="tel" placeholder="输入手机号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-password" for="signup-password">密码</label>
						<input class="full-width has-padding has-border" id="signup-password" type="password"  placeholder="输入密码">
					</p>
					<p class="fieldset">
						<label class="image-replace cd-password" for="signup-password">密码</label>
						<input class="full-width has-padding has-border" id="check-password" type="password"  placeholder="确认密码">
					</p>

					<!-- <p class="fieldset">
						<input type="checkbox" id="accept-terms">
						<label for="accept-terms">我已阅读并同意 <a href="#0">用户协议</a></label>
					</p> -->

					<p class="fieldset">
						<input class="full-width2" id = "signup-btn" type="submit" value="注册新用户">
					</p>
				</form>
			</div>

			<a href="#0" class="cd-close-form">关闭</a>
		</div>
	</div>

	<script type="text/template" id = "tpl_club">
		{@each txt as club}
		<div class = "allclub-item">
			<div class = "club-head">
				<a href="javascript:void(0)"><img src="$${club.head_url}" alt="$${club.name}"></a>
			</div>
			<div class = "allclub-info">
				<p>$${club.name}</p>
				<p>注册社员$${club.club_num}人</p>
			</div>
		</div>
		{@/each}
	</script>

	<script type="text/javascript">
		$(document).ready(function(){
			//维持用户登陆状态
			if (!sessionStorage.getItem('ifLog')){
				sessionStorage.setItem('ifLog','false');
			}
			if (sessionStorage.getItem('ifLog')=='true'){
				$('#leftLogin').css("display","block");
				$('#nav-user div:eq(0)').addClass('hd-hide');
				$('#nav-user div:eq(1)').removeClass('hd-hide');
				$('#nav-user div:eq(1) span:eq(1)').html(sessionStorage['stu_name']);
			}

			url_pre = "http://buaaclubs.com:3000";

			var tpl_club = $('#tpl_club').html();
			var tpl_club_c = juicer(tpl_club);

			$.ajax({
				url: url_pre+"/api/users/clubs/abstracts/tiyu",
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					var hhh = tpl_club_c.render(data);
					$("#tiyuClub").append(hhh);
				},
				error: function(){
					alert("error1");
				}
			});

			$.ajax({
				url: url_pre+"/api/users/clubs/abstracts/shijian",
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					var hhh = tpl_club_c.render(data);
					$("#shijianClub").append(hhh);
				},
				error: function(){
					alert("error2");
				}
			});

			$.ajax({
				url: url_pre+"/api/users/clubs/abstracts/keji",
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					var hhh = tpl_club_c.render(data);
					$("#kejiClub").append(hhh);
				},
				error: function(){
					alert("error3");
				}
			});


			$('form').submit(function(){
				return false;
			});

			$('#signin-btn').click(function(){
				var data = {
					uid: $('#signin-id').val(),
					passwd: $('#signin-password').val()
				}
				$.ajax({
					url: url_pre + "/api/users/login",
					type: "POST",
					dataType: "json",
					data: "uid="+data.uid+"&passwd="+hex_md5(data.passwd),
					success: function(data, textStatus){
						
						//dataObj = eval('('+data+')');
						dataObj = data;
						sessionStorage.setItem("stu_name",dataObj.name);
						sessionStorage.setItem("uid",dataObj.uid);
						sessionStorage.setItem("stu_token",dataObj.token);
						sessionStorage.setItem("stu_head",dataObj.user_head);
						sessionStorage.setItem("ifLog","true");

						$('#leftLogin').css("display","block");
						$('#nav-user div:eq(0)').addClass('hd-hide');
						$('#nav-user div:eq(1)').removeClass('hd-hide');
						$('#nav-user div:eq(1) span:eq(1)').html(dataObj.name);
					},
					error: function(){
						alert("signin error");
					}
				});

			});

			$('#logout-btn').click(function(){
				$.ajax({
					url: url_pre + "/api/users/logout",
					type: "GET",
					cache: false,
					beforeSend: function(request){
						request.setRequestHeader("token",sessionStorage["stu_token"]);
						request.setRequestHeader("uid",sessionStorage["uid"]);
						request.setRequestHeader("content-type","application/x-www-form-urlencoded");
					},
					success: function(data, textStatus){
						alert("登出成功！");
						sessionStorage.setItem("ifLog","false");
						sessionStorage.removeItem("uid");
						sessionStorage.removeItem("stu_head");
						sessionStorage.removeItem("stu_name");
						sessionStorage.removeItem("stu_token");

						$('#leftLogin').css("display","none");
						$('#nav-user div:eq(0)').removeClass('hd-hide');
						$('#nav-user div:eq(1)').addClass('hd-hide');
						$('#nav-user div:eq(1) span:eq(1)').html(' ');
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						alert("logout error");
					}
				});

			});

			$('#signup-btn').click(function(){
				if ($('#signup-password').val()!=$('#check-password').val()){
					alert("两次密码输入不同");
					return;
				}
				var data = {
					name: $('#signup-name').val(),
					uid: $('#signup-id').val(),
					passwd: $('#signup-password').val(),
					phone_num : $('#signup-tel').val(),
					email: $('#signup-email').val()
				}
				$.ajax({
					url: url_pre + "/api/register",
					type: "POST",
					dataType: "json",
					data:  "uid="+data.uid+"&passwd="+hex_md5(data.passwd)+"&name="+data.name+"&phone_num="+data.phone_num+"&email="+data.email,
					success: function(data, textStatus){
						alert("success");
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						if (XMLHttpRequest.status == 401) alert("该用户已被注册");
						else alert("注册遇到未知错误……");
					}
				});

			});



		});

	</script>

</body>
</html>