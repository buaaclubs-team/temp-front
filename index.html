<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>导航条设计</title>
	<link rel="stylesheet" type="text/css" href="font/iconfont.css">
	<link rel="stylesheet" type="text/css" href="header2.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src = "js/md5.js"></script>
	<script type="text/javascript" src = "js/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src = "js/juicer-min.js"></script>
	<script type="text/javascript" src="js/json2.js"></script>
	<script src="main.js"></script>
	
	
	<style type="text/css">
	
	</style>

	<script src="main.js"></script>
	<script type="text/javascript">
		var urlPre = "http://115.28.108.56:8080";
	</script>
</head>
<body>
	<div class = "app">
		<div class = "header">
			<div class="hd-content">
				<div class="logo">
					<img src="img/clubs-logo.png" alt="">
				</div>
				<ul class="nav">
					<li>
						<a href="index.html" class = "cur">
							<span class = "iconfont icon">&#xe60e;</span>
							<span>首页</span>
						</a>
					</li>
					<li>
						<a href="allClubs.html">
							<span class = "iconfont icon">&#xe631;</span>
							<span>百团</span>
						</a>
					</li>
					<li>
						<a href="discovery.html">
							<span class = "iconfont icon">&#xe600;</span>
							<span>发现</span>
						</a>
					</li>
				</ul>
				<ul class="nav hd-user" id="nav-user">
					<div class = "">
						<li >
							<a href="javascript:void(0)" class = "callModel">
								<span class = "iconfont icon">&#xe610;</span>
								<span>请登录</span>
							</a>
						</li>
					</div>
					<div class = "hd-hide">
						<li>
							<a href="javascript:void(0)">
								<span class = "iconfont icon">&#xe610;</span>
								<span> </span>
							</a>
						</li>
						<li>
							<a href="javascript:void(0)">
								<span class = "iconfont icon">&#xe618;<i class = ""></i></span>
							</a>
						</li>
						<li>
							<a href="javascript:void(0)" id = "logout-btn">
								<span class = "iconfont icon" style = "font-size:22px;">&#xe608;</span>
							</a>
						</li>
					</div>
				</ul>
			</div>
		</div>

		<div class="main">
			<div class="left-nav">
				<div class="left-item">
					<h3>
						<a href="index.html" class = "cur"><span>首页</span></a>
					</h3>
				</div>
				<div class="left-item">
					<h3>
						<a href="allClubs.html"><span>百团荟萃</span></a>
					</h3>
				</div>
				<div class="left-item">
					<h3>
						<a href="discovery.html"><span>发现活动</span></a>
					</h3>
				</div>
				<div id = "leftLogin" style = "display: none;">
					<div class="left-line"></div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>我的社团</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>我的活动</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>个人信息</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>站内信</span></a>
						</h3>
					</div>
				</div>
			</div>
			<div class="right-main">
				<!-- <em class = ""></em> -->
				<div class="right-tab">
					<ul>
						<li class = "cur"><a href="javascript:void(0)">全部</a>
							<span><i></i></span>
						</li>
						<li class = ""><a href="javascript:void(0)">活动</a><span><i></i></span></li>
						<li class = ""><a href="javascript:void(0)">资讯</a><span><i></i></span></li>
					</ul>
				</div>
				<div class="right-body" id="test1">
					<!-- 由juicer填充 -->

				</div>
			</div>
		</div>
	</div>


  <div class="cd-user-modal"> 
		<div class="cd-user-modal-container">
			<ul class="cd-switcher">
				<li><a href="#0">用户登录</a></li>
				<li><a href="#0">注册新用户</a></li>
			</ul>

			<div id="cd-login"> <!-- 登录表单 -->
				<form class="cd-form">
					<p class="fieldset">
						<label class="image-replace cd-username" for="signin-username">学号</label>
						<input class="full-width has-padding has-border" id="signin-id" type="text" placeholder="输入学号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-password" for="signin-password">密码</label>
						<input class="full-width has-padding has-border" id="signin-password" type="password"  placeholder="输入密码">
					</p>

					<p class="fieldset">
						<input class="full-width2 button1" id = "signin-btn" type="submit" value="登 录">
					</p>
				</form>
			</div>

			<div id="cd-signup"> <!-- 注册表单 -->
				<form class="cd-form">
					<p class="fieldset">
						<label class="image-replace cd-username" for="signup-username">学号</label>
						<input class="full-width has-padding has-border" id="signup-id" type="text" placeholder="输入学号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-email" for="signup-email">姓名</label>
						<input class="full-width has-padding has-border" id="signup-name" type="email" placeholder="输入姓名">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-email" for="signup-email">邮箱</label>
						<input class="full-width has-padding has-border" id="signup-email" type="email" placeholder="输入邮箱">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-email" for="signup-email">手机</label>
						<input class="full-width has-padding has-border" id="signup-tel" type="tel" placeholder="输入手机号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-password" for="signup-password">密码</label>
						<input class="full-width has-padding has-border" id="signup-password" type="password"  placeholder="输入密码">
					</p>
					<p class="fieldset">
						<label class="image-replace cd-password" for="signup-password">密码</label>
						<input class="full-width has-padding has-border" id="check-password" type="password"  placeholder="确认密码">
					</p>

					<!-- <p class="fieldset">
						<input type="checkbox" id="accept-terms">
						<label for="accept-terms">我已阅读并同意 <a href="#0">用户协议</a></label>
					</p> -->

					<p class="fieldset">
						<input class="full-width2" id = "signup-btn" type="submit" value="注册新用户">
					</p>
				</form>
			</div>

			<a href="#0" class="cd-close-form">关闭</a>
		</div>
	</div>


	<script type="text/template" id = "tpl_card">
		{@each txt as card}
			{@if card.article_type === 0}
			<div class="right-card zx">
			{@else if card.article_type === 1}
			<div class="right-card hd">
			{@else}
			<div class="right-card zx">
			{@/if}
				<div class="bgimg"></div>
				<div class="club-head">
					<a href="javascript:void(0)">
						<img src="${card.head_url}" alt="${card.club_name}">
						<p>${card.club_name}</p>
					</a>
				</div>
				<div class="card-content">
					<p class = "title"><a href="article.html" class = "jumpArticle" onclick = "sessionStorage.setItem('now_id',${card.article_id});">${card.article_title}</a></p>
					<p class = "line"></p>

					<p class = "abstract"><a href="article.html" class = "jumpArticle" onclick = "sessionStorage.setItem('now_id',$${card.article_id});">${card.article_abstract}</a></p>
					<span class="time">${card.time}</span>
					<a href="javascript:void(0)" class="enlist" onclick = "enList($${card.article_id});"><span>报 名</span></a>
				</div>
			</div>
		{@/each}
	</script>

	<script type="text/javascript">

		function enList(article_id){
			if (!sessionStorage.getItem('ifLog')){
				alert("请先登陆，登陆后才可以报名");
				return;
			}
			if (sessionStorage.getItem('ifLog')=="false"){
				alert("请先登陆，登陆后才可以报名");
				return;
			}
			$.ajax({
					url: url_pre + "/api/users/"+sessionStorage['uid']+"/articles/"+article_id+"/notes/create",
					type: "POST",
					beforeSend: function(request){
						request.setRequestHeader("token",sessionStorage["stu_token"]);
						request.setRequestHeader("uid",sessionStorage["uid"]);
						request.setRequestHeader("content-type","application/x-www-form-urlencoded");
					},
					success: function(data, textStatus){
						alert("报名成功！");
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						if (XMLHttpRequest.status == 401) alert("您已报过名");
						else alert("报名后台发生错误……");
					}
				});
		}

		$(document).ready(function(){
			if (!sessionStorage.getItem('ifLog')){
				sessionStorage.setItem('ifLog','false');
			}
			if (sessionStorage.getItem('ifLog')=='true'){
				$('#leftLogin').css("display","block");
				$('#nav-user div:eq(0)').addClass('hd-hide');
				$('#nav-user div:eq(1)').removeClass('hd-hide');
				$('#nav-user div:eq(1) span:eq(1)').html(sessionStorage['stu_name']);
			}
			
			url_pre = "http://buaaclubs.com:3000"; //定义全局
			pageCount = 0;
			nowKind = 2;  //控制当前显示所有还是活动还是资讯

			var $test1 = $('#test1');
			var tpl_card = $('#tpl_card').html();
			var tpl_card_c = juicer(tpl_card);

			$test1.html("");
			//获取开始
			pageCount++;
			$.ajax({
				url: url_pre + "/api/articles/"+pageCount.toString()+"/-1/"+nowKind.toString(),
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					var hhh = tpl_card_c.render(data);
					$test1.append(hhh);
				},
				error: function(){
					pageCount--;
				}
			});

			//获取开始
			pageCount++;
			$.ajax({
				url: url_pre + "/api/articles/"+pageCount.toString()+"/-1/"+nowKind.toString(),
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					var hhh = tpl_card_c.render(data);
					$test1.append(hhh);
				},
				error: function(){
					pageCount--;
				}
			});

			$('form').submit(function(){
				return false;
			});
			//获取结束，维护pageCount

			$(window).scroll(function(){
				
    	    	var htmlHeight=$(document).height();
		        var clientHeight=$(window).height();
        		var scrollTop=$(document).scrollTop();
	        	//console.log("htmlHeight: "+htmlHeight+"\nclientHeight: "+clientHeight+"\nscrollTop: "+scrollTop);
	        	if(scrollTop+clientHeight==htmlHeight){
	        		 pageCount++;
    	        	 $.ajax({
						url: url_pre + "/api/articles/"+pageCount.toString()+"/-1/"+nowKind.toString(),
						type: "GET",
						cache: false,
						dataType: "json",
						success: function(data, textStatus){
							var hhh = tpl_card_c.render(data);
							$test1.append(hhh);
						},
						error: function(){
							pageCount --;
						}
					});
        		}
    		});

    		$('#signin-btn').click(function(){
				var data = {
					uid: $('#signin-id').val(),
					passwd: $('#signin-password').val()
				}
				$.ajax({
					url: url_pre + "/api/users/login",
					type: "POST",
					dataType: "json",
					data: "uid="+data.uid+"&passwd="+hex_md5(data.passwd),
					success: function(data, textStatus){
						
						//dataObj = eval('('+data+')');
						dataObj = data;
						sessionStorage.setItem("stu_name",dataObj.name);
						sessionStorage.setItem("uid",dataObj.uid);
						sessionStorage.setItem("stu_token",dataObj.token);
						sessionStorage.setItem("stu_head",dataObj.user_head);
						sessionStorage.setItem("ifLog","true");

						$('#leftLogin').css("display","block");
						$('#nav-user div:eq(0)').addClass('hd-hide');
						$('#nav-user div:eq(1)').removeClass('hd-hide');
						$('#nav-user div:eq(1) span:eq(1)').html(dataObj.name);
					},
					error: function(){
						alert("signin error");
					}
				});

			});

			

			$('#logout-btn').click(function(){
				$.ajax({
					url: url_pre + "/api/users/logout",
					type: "GET",
					cache: false,
					beforeSend: function(request){
						request.setRequestHeader("token",sessionStorage["stu_token"]);
						request.setRequestHeader("uid",sessionStorage["uid"]);
						request.setRequestHeader("content-type","application/x-www-form-urlencoded");
					},
					success: function(data, textStatus){
						//alert("登出成功！");
						sessionStorage.setItem("ifLog","false");
						sessionStorage.removeItem("uid");
						sessionStorage.removeItem("stu_head");
						sessionStorage.removeItem("stu_name");
						sessionStorage.removeItem("stu_token");

						$('#leftLogin').css("display","none");
						$('#nav-user div:eq(0)').removeClass('hd-hide');
						$('#nav-user div:eq(1)').addClass('hd-hide');
						$('#nav-user div:eq(1) span:eq(1)').html(' ');
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						alert("logout error");
					}
				});

			});

			$('#signup-btn').click(function(){
				if ($('#signup-password').val()!=$('#check-password').val()){
					alert("两次密码输入不同");
					return;
				}
				var data = {
					name: $('#signup-name').val(),
					uid: $('#signup-id').val(),
					passwd: $('#signup-password').val(),
					phone_num : $('#signup-tel').val(),
					email: $('#signup-email').val()
				}
				$.ajax({
					url: url_pre + "/api/register",
					type: "POST",
					dataType: "json",
					data:  "uid="+data.uid+"&passwd="+hex_md5(data.passwd)+"&name="+data.name+"&phone_num="+data.phone_num+"&email="+data.email,
					success: function(data, textStatus){
						alert("success");
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						if (XMLHttpRequest.status == 401) alert("该用户已被注册");
						else alert("注册遇到未知错误……");
					}
				});

			});

			$(".right-tab a").click(function(){
				$(".right-tab li").removeClass("cur");
				$(this).parent().addClass("cur");
				nowKind = 2 - $(this).parent().index();
				pageCount = 0;
				$test1.html("");
				pageCount++;
				$.ajax({
					url: url_pre + "/api/articles/"+pageCount.toString()+"/-1/"+nowKind.toString(),
					type: "GET",
					cache: false,
					dataType: "json",
					success: function(data, textStatus){
						var hhh = tpl_card_c.render(data);
						$test1.append(hhh);
					},
					error: function(){
						pageCount--;
					}
				});
			});

		});

	</script>
</body>
</html>