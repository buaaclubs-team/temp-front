<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>导航条设计</title>
	<link rel="stylesheet" type="text/css" href="font/iconfont.css">
	<link rel="stylesheet" type="text/css" href="header2.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src = "js/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src = "js/md5.js"></script>
	<script type="text/javascript" src = "js/juicer-min.js"></script>
	<script type="text/javascript" src="js/json2.js"></script>
	<script src="main.js"></script>
	<style type="text/css">
	
	</style>


</head>
<body>
	<div class = "app">
		<div class = "header">
			<div class="hd-content">
				<div class="logo">
					<img src="img/clubs-logo.png" alt="">
				</div>
				<ul class="nav">
					<li>
						<a href="index.html" class = "">
							<span class = "iconfont icon">&#xe60e;</span>
							<span>首页</span>
						</a>
					</li>
					<li>
						<a href="allClubs.html">
							<span class = "iconfont icon">&#xe631;</span>
							<span>百团</span>
						</a>
					</li>
					<li>
						<a href="discovery.html">
							<span class = "iconfont icon">&#xe600;</span>
							<span>发现</span>
						</a>
					</li>
				</ul>
				<ul class="nav hd-user" id="nav-user">

					<div>
						<li >
							<a href="http://www.buaaclubs.com/myWeb/clubSignIn.html" class = "">
								<span class = "iconfont icon">&#xe627;</span>
								<span>社团后台</span>
							</a>
						</li>
						<li >
							<a href="javascript:void(0)" class = "callModel">
								<span class = "iconfont icon">&#xe610;</span>
								<span>请登录</span>
							</a>
						</li>
					</div>
					<div class = "hd-hide">
						<li>
							<a href="javascript:void(0)">
								<span class = "iconfont icon">&#xe610;</span>
								<span> </span>
							</a>
						</li>
						<li>
							<a href="myNotice.html">
								<span class = "iconfont icon">&#xe618;<i class = ""></i></span>
							</a>
						</li>
						<li>
							<a href="javascript:void(0)" id = "logout-btn">
								<span class = "iconfont icon" style = "font-size:22px;">&#xe608;</span>
							</a>
						</li>
					</div>
				</ul>
			</div>
		</div>

		<div class="main">
			<div class="left-nav">
				<div class="left-item">
					<h3>
						<a href="index.html" class = ""><span>首页</span></a>
					</h3>
				</div>
				<div class="left-item">
					<h3>
						<a href="allClubs.html"><span>百团荟萃</span></a>
					</h3>
				</div>
				<div class="left-item">
					<h3>
						<a href="discovery.html"><span>发现活动</span></a>
					</h3>
				</div>
				<div id = "leftLogin" style = "display: none;">
					<div class="left-line"></div>
					<div class="left-item">
						<h3>
							<a href="myClubs.html"><span>我的社团</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="myAct.html"><span>我的活动</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="javascript:void(0)"><span>个人信息</span></a>
						</h3>
					</div>
					<div class="left-item">
						<h3>
							<a href="myNotice.html"><span>站内信</span></a>
						</h3>
					</div>
				</div>
			</div>
			<div class="right-main">
				<div class="right-card details hd" id = "article-card">
					<div class="bgimg"></div>
					<div class="club-head" id = "article-head">
						<a href="javascript:void(0)">
							<img src="img/xunxing.jpg" alt="北斗巡星社">
						</a>
					</div>
					<div class="card-content" id = "article-titlex">
						<p class = "article-title"><a href="javascript:void(0)">北斗会内培训-天爱必备观测技术&&寒假远征宣讲</a></p>
						<p class = "line"></p>
						<p class="article-time">今天 13:11</p>
					</div>
					<div class = "article-body" id = "article-bodyx">
						<!-- 等待填充 -->
					</div>
					<div class="enlistbox">
						<a href="javascript:void" class="enlistBtn" onclick = "enList();"><span>报 名</span></a>
					</div>
				</div>
				<div class="comment">
					<div class="comment-publish login" style="display: none;" id = "cmt_publish">
						<div class="user-head">
							<img src="img/user_head.png" alt="江昊">
						</div>
						<div class="publish">
							<div class="p_input">
								<textarea maxlength="500" onfocus = "if (value=='回复评论：'){value=''}" onblur = "if(value==''){value='回复评论：'}" value = "回复评论：" id = "cmt_input">回复评论：</textarea>
							</div>
							<div class="p_button"><a href="javascript:void(0)" id = "cmt_btn">发 布</a></div>
							<div class="clear"></div>
						</div>
					</div>
					<div class="comment-all" id = "all_cmt">
						<span class = "comment-count" id = "cmt_count">评论 共30条</span>
						
						<div class="clear"></div>

						<!-- 等待juicer填充所有评论 -->
					</div>
					
				</div>
			</div>
		</div>
		<br>
	</div>
	
	<div class="cd-user-modal"> 
		<div class="cd-user-modal-container">
			<ul class="cd-switcher">
				<li><a href="#0">用户登录</a></li>
				<li><a href="#0">注册新用户</a></li>
			</ul>

			<div id="cd-login"> <!-- 登录表单 -->
				<form class="cd-form">
					<p class="fieldset">
						<label class="image-replace cd-username" for="signin-username">学号</label>
						<input class="full-width has-padding has-border" id="signin-id" type="text" placeholder="输入学号">
					</p>

					<p class="fieldset">
						<label class="image-replace cd-password" for="signin-password">密码</label>
						<input class="full-width has-padding has-border" id="signin-password" type="password"  placeholder="输入密码">
					</p>

					<p class="fieldset">
						<input class="full-width2 button1" id = "signin-btn" type="submit" value="登 录">
					</p>
				</form>
			</div>

			<div id="cd-signup"> <!-- 注册表单 -->
				<form class="cd-form">
					<p class="fieldset">
						<input class="full-width has-padding has-border" id="signup-id" type="text" placeholder="输入学号">
						<img src="img/right.png" alt="正确" style="width:30px;">
					</p>

					<p class="fieldset">
						<input class="full-width has-padding has-border" id="signup-idcard" type="text" placeholder="输入身份证后六位">
						<img src="img/right.png" alt="正确" style="width:30px;">
					</p>

					<p class="fieldset">
						<input class="full-width has-padding has-border" id="signup-email" type="text" placeholder="输入邮箱">
						<img src="img/right.png" alt="正确" style="width:30px;">
					</p>

					<p class="fieldset">
						<input class="full-width has-padding has-border" id="signup-tel" type="text" placeholder="输入手机号">
						<img src="img/right.png" alt="正确" style="width:30px;">
					</p>

					
					<!-- <p class="fieldset">
						<label class="image-replace cd-password" for="signup-password">密码</label>
						<input class="full-width has-padding has-border" id="check-password" type="password"  placeholder="确认密码">
					</p> -->
					<p class="fieldset">
						<input class="full-width has-padding has-border" id="signup-checkId" type="text"  placeholder="输入验证码" style="width:220px;">
						<input class="full-width2" id = "signup-getCheck" type="submit" value="免费获取验证码" style = "width:197px;margin-left: 20px;">
						<img src="img/right.png" alt="正确" style="width:30px;">
					</p>

					<p class="fieldset">
						<input class="full-width has-padding has-border" id="signup-password" type="password"  placeholder="输入密码">
					</p>
					
					<!-- <p class="fieldset">
						<input type="checkbox" id="accept-terms">
						<label for="accept-terms">我已阅读并同意 <a href="#0">用户协议</a></label>
					</p> -->

					<p class="fieldset">
						<input class="full-width2" id = "signup-btn" type="submit" value="注册新用户">
					</p>
				</form>
			</div>

			<a href="#0" class="cd-close-form">关闭</a>
		</div>
	</div> 
	<script type="text/template" id = "tpl_cmt">
		{@each txt as cmt}
			<div class="comment-list">
				<div class="comment-li">
					<div class="user-head">
						<img src="$${cmt.user_head}" alt="$${cmt.name}">
					</div>
					<div class="comment-con">
						<div class="comment-text">
							<span>$${cmt.name}</span>：$${cmt.content}
						</div>
						<div class="time">$${cmt.time}</div>
					</div>
				</div>
			</div>
		{@/each}
	</script>

	<script type="text/javascript">
		function enList(){
			article_id = sessionStorage["now_id"];
			if (!sessionStorage.getItem('ifLog')){
				alert("请先登陆，登陆后才可以报名");
				return;
			}
			if (sessionStorage.getItem('ifLog')=="false"){
				alert("请先登陆，登陆后才可以报名");
				return;
			}
			$.ajax({
					url: url_pre + "/api/users/"+sessionStorage['uid']+"/articles/"+article_id+"/notes/create",
					type: "POST",
					beforeSend: function(request){
						request.setRequestHeader("token",sessionStorage["stu_token"]);
						request.setRequestHeader("uid",sessionStorage["uid"]);
						request.setRequestHeader("content-type","application/x-www-form-urlencoded");
					},
					success: function(data, textStatus){
						alert("报名成功！");
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						if (XMLHttpRequest.status == 401) alert("您已报过名");
						else alert("您已报过名");
					}
				});
		}
		$(document).ready(function(){
			if (!sessionStorage.getItem('ifLog')){
				sessionStorage.setItem('ifLog','false');
			}
			if (sessionStorage.getItem('ifLog')=='true'){
				$('#leftLogin').css("display","block");
				$('#nav-user div:eq(0)').addClass('hd-hide');
				$('#nav-user div:eq(1)').removeClass('hd-hide');
				$('#nav-user div:eq(1) span:eq(1)').html(sessionStorage['stu_name']);
				$('#cmt_publish').css('display','block');
				$('#cmt_publish img').attr('src',sessionStorage['stu_head']);
				$('#cmt_publish img').attr('alt',sessionStorage['stu_name']);
			}
			url_pre = "http://buaaclubs.com:3000";
			//建立juicer
			var tpl_cmt = $('#tpl_cmt').html();
			var tpl_cmt_c = juicer(tpl_cmt);
			var $all_cmt = $('#all_cmt');

			$.ajax({
				url: url_pre + "/api/articles/detail/"+sessionStorage['now_id'],
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					$('#article-bodyx').html(data["content"]);
					$('#article-titlex a').html(data["title"]);
					$('#article-titlex p:eq(2)').html(data["time"]);
					$('#article-head img').attr('src',data["head_url"]);
					$('#article-head img').attr('alt',data["club_name"]);
					document.title = data["title"];
					if (data.type=="0"){
						$("#article-card").removeClass("hd");
						$("#article-card").addClass("zx");
					}
				},
				error: function(XMLHttpRequest, textStatus, errorThrown){
					alert(XMLHttpRequest.status);
					alert("error");
				}
			});

			$.ajax({
				url: url_pre + "/api/articles/"+sessionStorage['now_id']+"/comments",
				type: "GET",
				cache: false,
				dataType: "json",
				success: function(data, textStatus){
					var hhh = tpl_cmt_c.render(data);
					$all_cmt.append(hhh);
					$('#cmt_count').html("评论 共"+data["txt"].length+"条");
				},
				error: function(XMLHttpRequest, textStatus, errorThrown){
					$('#cmt_count').html("目前没有评论");
				}
			});



			$('form').submit(function(){
				return false;
			});

			$('#signin-btn').click(function(){
				var data = {
					uid: $('#signin-id').val(),
					passwd: $('#signin-password').val()
				}
				$.ajax({
					url: url_pre + "/api/users/login",
					type: "POST",
					dataType: "json",
					data: "uid="+data.uid+"&passwd="+hex_md5(data.passwd),
					success: function(data, textStatus){
						
						//dataObj = eval('('+data+')');
						dataObj = data;
						sessionStorage.setItem("stu_name",dataObj.name);
						sessionStorage.setItem("uid",dataObj.uid);
						sessionStorage.setItem("stu_head",dataObj.user_head);
						sessionStorage.setItem("ifLog","true");
						sessionStorage.setItem("stu_token",dataObj.token);

						$('#leftLogin').css("display","block");
						$('#nav-user div:eq(0)').addClass('hd-hide');
						$('#nav-user div:eq(1)').removeClass('hd-hide');
						$('#nav-user div:eq(1) span:eq(1)').html(dataObj.name);
						$('#cmt_publish').css('display','block');
						$('#cmt_publish img').attr('src',sessionStorage['stu_head']);
						$('#cmt_publish img').attr('alt',sessionStorage['stu_name']);
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						alert("signin error");
					}
				});

			});

			

			$('#logout-btn').click(function(){
				$.ajax({
					url: url_pre + "/api/users/logout",
					type: "GET",
					cache: false,
					beforeSend: function(request){
						request.setRequestHeader("token",sessionStorage["stu_token"]);
						request.setRequestHeader("uid",sessionStorage["uid"]);
						request.setRequestHeader("content-type","application/x-www-form-urlencoded");
					},
					success: function(data, textStatus){
						//alert("登出成功！");
						sessionStorage.setItem("ifLog","false");
						sessionStorage.removeItem("uid");
						sessionStorage.removeItem("stu_head");
						sessionStorage.removeItem("stu_name");
						sessionStorage.removeItem("stu_token");

						$('#leftLogin').css("display","none");
						$('#nav-user div:eq(0)').removeClass('hd-hide');
						$('#nav-user div:eq(1)').addClass('hd-hide');
						$('#nav-user div:eq(1) span:eq(1)').html(' ');
						$('#cmt_publish').css('display','none');

						$('.cd-user-modal').removeClass('is-visible');
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						alert("logout error");
					}
				});

			});

			$('#cmt_btn').click(function(){
				var data = {
					stu_id: sessionStorage['uid'],
					now_id: sessionStorage['now_id'],
					content: $('#cmt_input').val()
				};
				$.ajax({
					url: url_pre + "/api/users/articles/"+sessionStorage['now_id']+"/comments/reply/-1",
					type: "POST",
					data: JSON.stringify(data),
					beforeSend: function(request){
						request.setRequestHeader("uid",sessionStorage["uid"]);
						request.setRequestHeader("token",sessionStorage["stu_token"]);
						request.setRequestHeader("content-type","application/x-www-form-urlencoded");
					},
					success: function(data, textStatus){
						location.reload();
					},
					error: function(){
						alert("评论出错 error");
					}
				});
			});

			//以下是注册处理

			var wait = 60;
			function myTime(o){
				if (wait == 0){
					o.removeAttribute("disabled");
					o.value = "免费获取验证码";
					wait = 60;
				}
				else {
					o.setAttribute("disabled");
					o.value = "重新发送("+wait+")";
					wait --;
					setTimeout(function(){myTime(o)},1000);
				}
			}

			document.getElementById("signup-getCheck").onclick = function(){myTime(this);}



			var flag1 = false,flag2 = false,flag3 = false,flag4 = false,flag5 = false;
			var signup_name;
		
			$("#signup-id").blur(function(){  //1
				if ($("#signup-id").val()==""){
					$("#signup-id").next("img").css("display","inline");
					$("#signup-id").next("img").attr("src","img/wrong.png");
					flag1 = false;
				}
				else {
					$.ajax({
						url: url_pre + "/api/users/register/check/"+$("#signup-id").val(),
						type: "GET",
						cache: false,
						dataType: 'json',
						success: function(data,textStatus){
							$("#signup-id").next("img").css("display","inline");
							$("#signup-id").next("img").attr("src","img/right.png");
							flag1 = true;
						},
						error: function(data,textStatus){
							$("#signup-id").next("img").css("display","inline");
							$("#signup-id").next("img").attr("src","img/wrong.png");
							flag1 = false;
						}
					});
				}
			});

			$("#signup-idcard").blur(function(){  //2
				data = {
					stu_num: $("#signup-id").val(),
					iden_num: $("#signup-idcard").val(),
				}
				if ($("#signup-idcard").val().length!=6){
					$("#signup-idcard").next("img").css("display","inline");
					$("#signup-idcard").next("img").attr("src","img/wrong.png");
					flag2 = false;
				}
				else {
					$.ajax({
						url: url_pre + "/api/users/register/checkiden",
						type: "POST",
						cache: false,
						data: JSON.stringify(data),
						dataType: "json",
						success: function(data,textStatus){
							$("#signup-idcard").next().css("display","inline");
							$("#signup-idcard").next().attr("src","img/right.png");
							flag2 = true;
							signup_name = data.name;
						},
						error: function(data,textStatus){
							$("#signup-idcard").next().css("display","inline");
							$("#signup-idcard").next().attr("src","img/wrong.png");
							flag2 = false;
						}
					});
				}
			});

			$("#signup-email").blur(function(){
				if ($("#signup-email").val().match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/)){
					$("#signup-email").next("img").css("display","inline");
					$("#signup-email").next("img").attr("src","img/right.png");
					flag3 = true;
				}
				else {
					$("#signup-email").next("img").css("display","inline");
					$("#signup-email").next("img").attr("src","img/wrong.png");
					flag3 = false;
				}
			});

			$("#signup-tel").blur(function(){
				if ($("#signup-tel").val().match(/^[1][0-9]{10}$/)){
					$("#signup-tel").next("img").css("display","inline");
					$("#signup-tel").next("img").attr("src","img/right.png");
					flag4 = true;
				}
				else {
					$("#signup-tel").next("img").css("display","inline");
					$("#signup-tel").next("img").attr("src","img/wrong.png");
					flag4 = false;
				}
			});

			$("#signup-getCheck").click(function(){
				data = {
					phone_num: $("#signup-tel").val()
				}
				if (!$("#signup-tel").val().match(/^[1][0-9]{10}$/)){
					alert("请输入正确的手机号码");
				}
				else {
					$.ajax({
						url: url_pre + "/api/users/phone_num/verify/code",
							type: "POST",
						cache: false,
						data: JSON.stringify(data),
						success: function(data,textStatus){
							alert("发送短信成功");
						},
						error: function(data,textStatus){
							alert("发送短信失败");
						}
					});
				}
			});

			$("#signup-checkId").blur(function(){
				data = {
					phone_num: $("#signup-tel").val(),
					code: hex_md5($("#signup-checkId").val())
				}
				if ($("#signup-checkId").val().length!=4){
					$("#signup-checkId").next().next("img").css("display","inline");
					$("#signup-checkId").next().next("img").attr("src","img/wrong.png");
					flag5 = false;
				}
				else {
					$.ajax({
						url: url_pre + "/api/users/phone_num/verify",
						type: "POST",
						cache: false,
						data: JSON.stringify(data),
						success: function(data,textStatus){
							$("#signup-checkId").next().next("img").css("display","inline");
							$("#signup-checkId").next().next("img").attr("src","img/right.png");
							flag5 = true;
						},
						error: function(data,textStatus){
							$("#signup-checkId").next().next("img").css("display","inline");
							$("#signup-checkId").next().next("img").attr("src","img/wrong.png");
							flag5 = false;
						}
					});
				}
			});

			$('#signup-btn').click(function(){
				var data;

				data = {
					stu_num: $("#signup-id").val(),
					iden_num: $("#signup-idcard").val(),
				}
				if ($("#signup-idcard").val().length!=6){
					$("#signup-idcard").next("img").css("display","inline");
					$("#signup-idcard").next("img").attr("src","img/wrong.png");
					flag2 = false;
				}
				else {
					$.ajax({
						url: url_pre + "/api/users/register/checkiden",
						type: "POST",
						async: false,
						cache: false,
						data: JSON.stringify(data),
						dataType: "json",
						success: function(data,textStatus){
							$("#signup-idcard").next().css("display","inline");
							$("#signup-idcard").next().attr("src","img/right.png");
							flag2 = true;
							signup_name = data.name;
						},
						error: function(data,textStatus){
							$("#signup-idcard").next().css("display","inline");
							$("#signup-idcard").next().attr("src","img/wrong.png");
							flag2 = false;
						}
					});
				}

				if ($("#signup-email").val().match(/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/)){
					$("#signup-email").next("img").css("display","inline");
					$("#signup-email").next("img").attr("src","img/right.png");
					flag3 = true;
				}
				else {
					$("#signup-email").next("img").css("display","inline");
					$("#signup-email").next("img").attr("src","img/wrong.png");
					flag3 = false;
				}

				if ($("#signup-tel").val().match(/^[1][0-9]{10}$/)){
					$("#signup-tel").next("img").css("display","inline");
					$("#signup-tel").next("img").attr("src","img/right.png");
					flag4 = true;
				}
				else {
					$("#signup-tel").next("img").css("display","inline");
					$("#signup-tel").next("img").attr("src","img/wrong.png");
					flag4 = false;
				}


				data = {
					phone_num: $("#signup-tel").val(),
					code: hex_md5($("#signup-checkId").val())
				}
				if ($("#signup-checkId").val().length!=4){
					$("#signup-checkId").next().next("img").css("display","inline");
					$("#signup-checkId").next().next("img").attr("src","img/wrong.png");
					flag5 = false;
				}
				else {
					$.ajax({
						url: url_pre + "/api/users/phone_num/verify",
						type: "POST",
						async: false,
						cache: false,
						data: JSON.stringify(data),
						success: function(data,textStatus){
							$("#signup-checkId").next().next("img").css("display","inline");
							$("#signup-checkId").next().next("img").attr("src","img/right.png");
							flag5 = true;
						},
						error: function(data,textStatus){
							$("#signup-checkId").next().next("img").css("display","inline");
							$("#signup-checkId").next().next("img").attr("src","img/wrong.png");
							flag5 = false;
						}
					});
				}

				if ($("#signup-password").val().length<8){
					alert("密码应在八位及以上");
				}
				else if (flag1&&flag2&&flag3&&flag4&&flag5){
					data = {
						name: signup_name,
						uid: $('#signup-id').val(),
						email: $('#signup-email').val(),
						phone_num : $('#signup-tel').val(),
						passwd: $('#signup-password').val()
					}
					$.ajax({
						url: url_pre + "/api/register",
						type: "POST",
						dataType: "json",
						data:  "uid="+data.uid+"&passwd="+hex_md5(data.passwd)+"&name="+data.name+"&phone_num="+data.phone_num+"&email="+data.email,
						success: function(data, textStatus){
							$('.cd-user-modal').removeClass('is-visible');
							alert("success");
							$('#leftLogin').css("display","block");
							$('#nav-user div:eq(0)').addClass('hd-hide');
							$('#nav-user div:eq(1)').removeClass('hd-hide');
							$('#nav-user div:eq(1) span:eq(1)').html(dataObj.name);
						},
						error: function(XMLHttpRequest, textStatus, errorThrown){
							if (XMLHttpRequest.status == 401) alert("该用户已被注册");
							else alert("注册遇到未知错误……");
						}
					});
				}
				else{
					alert("输入信息有错误");
				}

			});

		});
	</script>
	
	
</body>
</html>